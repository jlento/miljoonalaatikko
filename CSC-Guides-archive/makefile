SHELL := /bin/bash

# Depends on GHC/Haskell-platform, pandoc, xelatex, etc!
GHC    := $(shell which ghc)
PANDOC := $(HOME)/.cabal/bin/pandoc

# Base url
BASEURL  := https://research.csc.fi

# Path to this makefile and utils directory
THIS_DIR := $(dir $(lastword $(MAKEFILE_LIST)))
UTILS    := $(THIS_DIR)utils/

# The list of books to make defined in <book name>.mk files
books      := $(basename $(notdir $(wildcard $(THIS_DIR)*.mk)))
books_pdf  := $(addsuffix .pdf,$(books))

# Some auxiliary files and tools for pandoc
FILTER       := guidebook
HEADER_LATEX := $(UTILS)graybox.tex

# Load book contents from file <book>.mk, i.e. variables
#   <book>_TITLE := <title of the book>
#   <book>_URLS := <list of urls relative to BASEURL>
define load-book
this := $(1)
include $(THIS_DIR)$(1).mk
endef
$(foreach book,$(books),$(eval $(call load-book,$(book))))

.PHONY : all clean

all : $(books_pdf)

define book-rules
$(1).pdf : $(FILTER) $(HEADER_LATEX)
	pandoc --filter ./$(FILTER) \
               -M title="$$($(1)_TITLE)" \
               -M author="Autogenerated from HTML pages with pandoc" \
               -M date="$(shell date +%x)" \
               -M documentclass="article" \
               -M classoption="titlepage" \
               -M bodyclass="journal-content-article" \
               -M baseurl="$(BASEURL)" \
               --latex-engine=xelatex --toc -V papersize=a4paper \
               -V geometry=margin=1in -H $(HEADER_LATEX) -o $$@ \
               $$(addprefix $(BASEURL)/,$$($(1)_URLS))
endef
$(foreach book,$(books),$(eval $(call book-rules,$(book))))

$(FILTER) : $(UTILS)$(FILTER).hs
	$(GHC) --make -outputdir . -o $@ $<

greplinks : $(UTILS)greplinks.hs
	$(GHC) --make -outputdir . -o $@ $<

clean :
	rm -f *.pdf *.log *.aux *.dvi *.tex *.toc *.out *.o *.hi $(FILTER) greplinks
